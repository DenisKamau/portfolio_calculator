<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Invested Capital Calculator</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        @media (max-width: 768px) {
            body {
                padding: 8px;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
                font-size: 13px;
            }
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
                border-radius: 12px;
            }
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 2.2em;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
                margin-bottom: 15px;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.5em;
                margin-bottom: 12px;
            }
        }

        .input-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        @media (max-width: 768px) {
            .input-section {
                padding: 15px;
                margin-bottom: 20px;
            }
        }

        @media (max-width: 480px) {
            .input-section {
                padding: 12px;
                border-radius: 8px;
            }
        }

        .input-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        @media (max-width: 768px) {
            .input-row {
                grid-template-columns: 1fr;
                gap: 10px;
                padding: 15px;
            }

            .input-row.header-row {
                display: none;
            }

            .remove-btn {
                margin-top: 10px;
                justify-self: center;
            }
        }

        .input-row:last-child {
            margin-bottom: 0;
        }

        .header-row {
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 8px;
        }

        input {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }

        @media (max-width: 768px) {
            input {
                padding: 12px;
                font-size: 16px;
            }
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .stock-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .remove-btn {
            background: transparent;
            color: #6c757d;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .remove-btn:hover {
            background: #f8f9fa;
            color: #dc3545;
            border-color: #dc3545;
        }

        .remove-btn:active {
            transform: scale(0.95);
        }

        .add-row-btn,
        .calculate-btn,
        .clear-btn,
        .sample-btn,
        .import-btn,
        .export-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            min-width: 120px;
        }

        @media (max-width: 768px) {

            .add-row-btn,
            .calculate-btn,
            .clear-btn,
            .sample-btn,
            .import-btn,
            .export-btn {
                width: 100%;
                max-width: 300px;
                padding: 15px 20px;
                font-size: 16px;
                margin: 8px 0;
            }
        }

        @media (max-width: 480px) {

            .add-row-btn,
            .calculate-btn,
            .clear-btn,
            .sample-btn,
            .import-btn,
            .export-btn {
                padding: 14px 16px;
                font-size: 15px;
                margin: 6px 0;
                min-width: 100px;
            }
        }

        .performance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .performance-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        .performance-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
        }

        @media (max-width: 768px) {

            .performance-table th,
            .performance-table td {
                padding: 8px 4px;
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            .performance-table {
                font-size: 11px;
            }

            .performance-table th,
            .performance-table td {
                padding: 6px 2px;
                font-size: 11px;
            }
        }

        .performance-table tr:last-child td {
            border-bottom: none;
        }

        .performance-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .performance-table tr:hover {
            background-color: #e3f2fd;
        }

        .rank-cell {
            text-align: center;
            font-weight: bold;
            width: 40px;
        }

        .asset-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .positive-return {
            color: #28a745;
            font-weight: 600;
        }

        .negative-return {
            color: #dc3545;
            font-weight: 600;
        }

        @media (max-width: 768px) {

            .add-row-btn,
            .calculate-btn,
            .clear-btn,
            .sample-btn,
            .import-btn,
            .export-btn {
                width: 100%;
                max-width: 300px;
                padding: 15px 20px;
                font-size: 16px;
            }
        }

        .add-row-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .calculate-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 16px;
        }

        .clear-btn {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .sample-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .import-btn {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }

        .export-btn {
            background: linear-gradient(135deg, #fd7e14, #e55a4e);
            color: white;
        }

        .add-row-btn:hover,
        .calculate-btn:hover,
        .clear-btn:hover,
        .sample-btn:hover,
        .import-btn:hover,
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .button-container {
            text-align: center;
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .button-container {
                flex-direction: column;
                align-items: center;
            }
        }

        .results {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 25px;
            margin-top: 30px;
            border-left: 5px solid #667eea;
        }

        @media (max-width: 768px) {
            .results {
                padding: 20px;
                margin-top: 20px;
                border-radius: 8px;
            }
        }

        @media (max-width: 480px) {
            .results {
                padding: 15px;
                margin-top: 15px;
            }
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #dee2e6;
            font-size: 16px;
        }

        @media (max-width: 768px) {
            .result-item {
                flex-direction: column;
                align-items: flex-start;
                font-size: 14px;
                padding: 10px 0;
            }

            .result-item span:last-child {
                margin-top: 5px;
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            .result-item {
                font-size: 13px;
                padding: 8px 0;
            }
        }

        .result-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .profit {
            color: #28a745;
            font-weight: 600;
        }

        .loss {
            color: #dc3545;
            font-weight: 600;
        }

        .neutral {
            color: #6c757d;
            font-weight: 600;
        }

        .view-toggle-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            border-radius: 6px;
            background: white;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .view-toggle-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
        }

        .view-toggle-btn.active {
            background: #667eea;
            color: white;
        }

        @media (max-width: 480px) {
            .view-toggle-btn {
                padding: 10px 12px;
                font-size: 12px;
            }
        }

        /* Notification Toast Styles */
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 16px 24px;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            font-weight: 600;
            font-size: 14px;
            z-index: 10000;
            min-width: 300px;
            max-width: 450px;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            align-items: center;
            gap: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .notification-toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification-toast.success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .notification-toast.info {
            background: linear-gradient(135deg, #17a2b8, #138496);
        }

        .notification-toast.warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
        }

        .notification-toast.error {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .notification-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
            line-height: 1.4;
        }

        .notification-close {
            background: none;
            border: none;
            color: inherit;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            margin-left: 8px;
            opacity: 0.8;
            transition: opacity 0.2s ease;
            flex-shrink: 0;
        }

        .notification-close:hover {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .notification-toast {
                top: 10px;
                right: 10px;
                left: 10px;
                min-width: unset;
                max-width: unset;
                transform: translateY(-100%);
                font-size: 13px;
                padding: 14px 18px;
            }

            .notification-toast.show {
                transform: translateY(0);
            }

            .notification-icon {
                font-size: 18px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>📊 Portfolio Capital & Performance Analyzer</h1>

        <!-- Currency Selector -->
        <div class="currency-selector" style="text-align: center; margin-bottom: 25px;">
            <div
                style="background: rgba(102, 126, 234, 0.1); border-radius: 12px; padding: 15px; display: inline-block;">
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap; justify-content: center;">
                    <div>
                        <label for="currencySelect" style="font-weight: 600; color: #2c3e50; margin-right: 10px;">💱
                            Currency:</label>
                        <select id="currencySelect" onchange="changeCurrency()"
                            style="padding: 8px 12px; border: 2px solid #667eea; border-radius: 6px; font-size: 14px; font-weight: 600; color: #2c3e50; background: white; cursor: pointer;">
                            <option value="USD" selected>🇺🇸 USD - US Dollar</option>
                            <option value="KSH">🇰🇪 KSH - Kenyan Shilling</option>
                        </select>
                    </div>
                    <div id="exchangeRateDisplay" style="font-size: 12px; color: #6c757d; display: none;">
                        <span id="rateText">Loading rate...</span>
                    </div>
                    <div id="customRateSection" style="display: none;">
                        <label for="customRate" style="font-weight: 600; color: #2c3e50; margin-right: 8px;">Custom
                            Rate:</label>
                        <input type="number" id="customRate" placeholder="130" min="0.01" step="0.01"
                            style="width: 80px; padding: 6px 8px; border: 2px solid #667eea; border-radius: 4px; font-size: 13px;">
                        <button onclick="applyCustomRate()"
                            style="padding: 6px 12px; margin-left: 8px; background: #667eea; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Apply</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="intro-section"
            style="background: linear-gradient(135deg, #e3f2fd, #f3e5f5); border-radius: 12px; padding: 20px; margin-bottom: 25px; border-left: 5px solid #667eea;">
            <h3 style="margin: 0 0 15px 0; color: #2c3e50;">🎯 What This Tool Does</h3>
            <p style="margin: 0 0 10px 0; color: #34495e; line-height: 1.6;">
                <strong>Calculate your true invested capital</strong> by removing profits and adding back losses from
                current values.
                Plus get comprehensive portfolio analysis with performance insights and actionable recommendations.
            </p>
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                <div style="background: rgba(255,255,255,0.7); padding: 12px; border-radius: 8px;">
                    <strong>💰 Capital Calculation</strong><br>
                    <small>Find your actual invested amount</small>
                </div>
                <div style="background: rgba(255,255,255,0.7); padding: 12px; border-radius: 8px;">
                    <strong>📈 Performance Analysis</strong><br>
                    <small>Detailed portfolio insights</small>
                </div>
                <div style="background: rgba(255,255,255,0.7); padding: 12px; border-radius: 8px;">
                    <strong>🎯 Smart Recommendations</strong><br>
                    <small>Actionable investment advice</small>
                </div>
            </div>
        </div>

        <div class="input-section">
            <div class="section-header"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h3 style="margin: 0; color: #2c3e50;">📝 Enter Your Portfolio Data</h3>
                <div class="data-options" style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="sample-btn" onclick="loadSampleData()">Load Sample Data</button>
                    <button class="clear-btn" onclick="clearAll()">Clear All</button>
                </div>
            </div>

            <div class="help-text"
                style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px; color: #856404;">
                <strong>💡 How to use:</strong> Enter each asset's current value and gain/loss amount. The tool will
                calculate your original invested capital and provide detailed analysis.
                <br><br>
                <strong>Example:</strong> If AAPL is worth $1,000 today and you're up $200, you originally invested
                $800.
            </div>

            <div class="input-row header-row" id="headerRow">
                <div>Stock/Asset Name</div>
                <div id="currentValueHeader">Current Value ($)</div>
                <div id="gainLossHeader">Gain/Loss ($)</div>
                <div></div>
            </div>
            <div id="inputRows">
                <!-- Rows will be added dynamically -->
            </div>
            <div class="button-container">
                <button class="add-row-btn" onclick="addRow()">+ Add Asset</button>
                <button class="sample-btn" onclick="shareWebsite()">� Share Website</button>
            </div>
        </div>

        <div class="button-container">
            <button class="calculate-btn" onclick="calculate()">🚀 Analyze My Portfolio</button>
            <!--
                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                <label for="ageInput" style="font-weight: 600; color: #2c3e50;">Age (optional):</label>
                <input type="number" id="ageInput" placeholder="25" min="18" max="100"
                    style="width: 80px; padding: 8px; border: 2px solid #e1e5e9; border-radius: 6px;">
                <small style="color: #6c757d;">For personalized risk analysis</small>
            </div>
            -->

            <button class="export-btn" onclick="exportResults()" style="display: none;">📊 Export Results</button>
        </div>

        <div id="results" class="results" style="display: none;">
            <h3 style="margin-top: 0; color: #2c3e50;">📈 Portfolio Analysis</h3>
            <div id="resultsList"></div>

            <!-- Market Performance Overview -->
            <!--

            <div style="margin-top: 30px;">
                <h3 style="color: #2c3e50; margin-bottom: 20px;">📊 Market Performance Overview (YTD)</h3>
                <div id="marketPerformance"
                    style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="loading-placeholder" style="text-align: center; padding: 20px; color: #6c757d;">
                            📊 Loading market data...
                        </div>
                    </div>
                </div>
            </div>-->

            <div style="margin-top: 30px;">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h3 style="color: #2c3e50; margin: 0;">📊 Portfolio Visualization</h3>
                    <div style="display: flex; gap: 10px;">
                        <button id="chartViewBtn" class="view-toggle-btn" onclick="switchView('chart')">📊 Chart
                            View</button>
                        <button id="tableViewBtn" class="view-toggle-btn active" onclick="switchView('table')">📋 Table
                            View</button>
                    </div>
                </div>
                <div id="chartView"
                    style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; overflow-x: auto; display: none;">
                    <canvas id="portfolioChart"
                        style="max-width: 100%; height: auto; min-height: 200px; max-height: 250px;"></canvas>
                </div>
                <div id="tableView"
                    style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; overflow-x: auto;">
                    <table class="performance-table" id="performanceTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Asset Name</th>
                                <th>Current Value</th>
                                <th>Invested Capital</th>
                                <th>Gain/Loss</th>
                                <th>Return %</th>
                                <th>Portfolio %</th>
                            </tr>
                        </thead>
                        <tbody id="performanceTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div style="margin-top: 30px;">
                <h3 style="color: #2c3e50; margin-bottom: 20px;">🔍 Portfolio Insights</h3>
                <div id="analysisSection" style="background: white; border-radius: 12px; padding: 20px;"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        // Global currency setting
        let currentCurrency = 'USD';
        let previousCurrency = 'USD';
        let usingCustomRate = false;

        // Exchange rates (will be fetched dynamically)
        let exchangeRates = {
            USD: 1,
            KSH: 130 // Default fallback rate
        };

        // Fetch real-time exchange rates
        async function fetchExchangeRates()
        {
            try
            {
                // Using exchangerate-api.com (free API)
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await response.json();

                if (data && data.rates && data.rates.KES)
                {
                    exchangeRates.KSH = data.rates.KES;
                    updateRateDisplay();
                    console.log('Exchange rates updated:', exchangeRates);
                    return true;
                }
            } catch (error)
            {
                console.error('Error fetching exchange rates:', error);
            }

            // Fallback: Try alternative API
            try
            {
                const response = await fetch('https://api.fixer.io/latest?base=USD&symbols=KES&access_key=demo');
                const data = await response.json();

                if (data && data.rates && data.rates.KES)
                {
                    exchangeRates.KSH = data.rates.KES;
                    updateRateDisplay();
                    return true;
                }
            } catch (error)
            {
                console.error('Fallback API also failed:', error);
            }

            // Use hardcoded fallback
            updateRateDisplay();
            return false;
        }

        // Update the rate display
        function updateRateDisplay()
        {
            const rateDisplay = document.getElementById('exchangeRateDisplay');
            const rateText = document.getElementById('rateText');

            if (currentCurrency === 'KSH')
            {
                const rate = exchangeRates.KSH.toFixed(2);
                const source = usingCustomRate ? '(Custom)' : '(Live)';
                rateText.textContent = `1 USD = ${rate} KSH ${source}`;
                rateDisplay.style.display = 'block';

                // Show custom rate input
                document.getElementById('customRateSection').style.display = 'block';
                document.getElementById('customRate').placeholder = rate;
            } else
            {
                rateDisplay.style.display = 'none';
                document.getElementById('customRateSection').style.display = 'none';
            }
        }

        // Apply custom exchange rate
        function applyCustomRate()
        {
            const customRateInput = document.getElementById('customRate');
            const customRate = parseFloat(customRateInput.value);

            if (customRate && customRate > 0)
            {
                exchangeRates.KSH = customRate;
                usingCustomRate = true;
                updateRateDisplay();

                // Update displayed values if results are shown
                if (window.currentResults)
                {
                    const results = window.currentResults;
                    const totalCurrentValue = results.reduce((sum, r) => sum + r.currentValue, 0);
                    const totalInvestedCapital = results.reduce((sum, r) => sum + r.investedAmount, 0);
                    const totalProfitLoss = results.reduce((sum, r) => sum + r.gainAmount, 0);

                    displayResults(results, totalCurrentValue, totalInvestedCapital, totalProfitLoss);
                }

                showNotification(`Custom exchange rate applied: 1 USD = ${customRate} KSH 💱`, 'success', 3000);
                customRateInput.value = '';
            } else
            {
                showNotification('Please enter a valid exchange rate!', 'warning', 3000);
            }
        }

        // Update header and input placeholders based on currency
        function updateInputLabels()
        {
            const currentValueHeader = document.getElementById('currentValueHeader');
            const gainLossHeader = document.getElementById('gainLossHeader');
            const currencySymbol = currentCurrency === 'USD' ? '$' : 'KSh';

            // Update header labels
            currentValueHeader.textContent = `Current Value (${currencySymbol})`;
            gainLossHeader.textContent = `Gain/Loss (${currencySymbol})`;

            // Update all input placeholders and convert values
            const inputRows = document.querySelectorAll('#inputRows .input-row');

            inputRows.forEach(row =>
            {
                const inputs = row.querySelectorAll('input');
                const currentValueInput = inputs[ 1 ]; // Second input (current value)
                const gainLossInput = inputs[ 2 ]; // Third input (gain/loss)

                // Update placeholders
                currentValueInput.placeholder = `Current Value (${currencySymbol})`;
                gainLossInput.placeholder = `Gain/Loss (${currencySymbol})`;

                // Convert existing values if they exist
                if (currentValueInput.value && !isNaN(parseFloat(currentValueInput.value)))
                {
                    const currentValue = parseFloat(currentValueInput.value);
                    if (currentCurrency === 'KSH')
                    {
                        // Convert from USD to KSH
                        currentValueInput.value = (currentValue * exchangeRates.KSH).toFixed(0);
                    } else
                    {
                        // Convert from KSH to USD
                        currentValueInput.value = (currentValue / exchangeRates.KSH).toFixed(2);
                    }
                }

                if (gainLossInput.value && !isNaN(parseFloat(gainLossInput.value)))
                {
                    const gainLossValue = parseFloat(gainLossInput.value);
                    if (currentCurrency === 'KSH')
                    {
                        // Convert from USD to KSH
                        gainLossInput.value = (gainLossValue * exchangeRates.KSH).toFixed(0);
                    } else
                    {
                        // Convert from KSH to USD
                        gainLossInput.value = (gainLossValue / exchangeRates.KSH).toFixed(2);
                    }
                }
            });
        }

        // Currency change function
        function changeCurrency()
        {
            const selector = document.getElementById('currencySelect');
            previousCurrency = currentCurrency;
            currentCurrency = selector.value;

            updateRateDisplay();

            // Only convert if currency actually changed
            if (previousCurrency !== currentCurrency)
            {
                updateInputLabels();
            }

            // Update all displayed currency values if results are shown
            if (window.currentResults)
            {
                const results = window.currentResults;
                const totalCurrentValue = results.reduce((sum, r) => sum + r.currentValue, 0);
                const totalInvestedCapital = results.reduce((sum, r) => sum + r.investedAmount, 0);
                const totalProfitLoss = results.reduce((sum, r) => sum + r.gainAmount, 0);

                displayResults(results, totalCurrentValue, totalInvestedCapital, totalProfitLoss);
            }

            // Show notification
            const currencyName = currentCurrency === 'USD' ? 'US Dollars' : 'Kenyan Shillings';
            showNotification(`Currency changed to ${currencyName} 💱`, 'info', 3000);
        }

        // Helper function to format currency with commas
        function formatCurrency(amount)
        {
            const convertedAmount = currentCurrency === 'KSH' ? amount * exchangeRates.KSH : amount;

            return new Intl.NumberFormat(currentCurrency === 'KSH' ? 'en-KE' : 'en-US', {
                style: 'currency',
                currency: currentCurrency,
                minimumFractionDigits: currentCurrency === 'KSH' ? 0 : 2,
                maximumFractionDigits: currentCurrency === 'KSH' ? 0 : 2
            }).format(convertedAmount);
        }

        // Helper function to format numbers with commas (no currency symbol)
        function formatNumber(amount)
        {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        let rowCount = 0;

        // Notification system
        function showNotification(message, type = 'success', duration = 4000)
        {
            // Remove any existing notifications first
            const existingToast = document.querySelector('.notification-toast');
            if (existingToast)
            {
                existingToast.remove();
            }

            // Create notification element
            const toast = document.createElement('div');
            toast.className = `notification-toast ${type}`;

            // Set icon based on type
            const icons = {
                success: '✅',
                info: 'ℹ️',
                warning: '⚠️',
                error: '❌'
            };

            toast.innerHTML = `
                <div class="notification-icon">${icons[ type ] || icons.success}</div>
                <div class="notification-content">${message}</div>
                <button class="notification-close" onclick="hideNotification()">&times;</button>
            `;

            // Add to document
            document.body.appendChild(toast);

            // Trigger slide-in animation
            setTimeout(() =>
            {
                toast.classList.add('show');
            }, 100);

            // Auto-hide after specified duration
            if (duration > 0)
            {
                setTimeout(() =>
                {
                    hideNotification();
                }, duration);
            }
        }

        function hideNotification()
        {
            const toast = document.querySelector('.notification-toast');
            if (toast)
            {
                toast.classList.remove('show');
                setTimeout(() =>
                {
                    if (toast.parentNode)
                    {
                        toast.parentNode.removeChild(toast);
                    }
                }, 400); // Match the CSS transition duration
            }
        }

        // Pre-populate with sample portfolio data for demonstration
        const samplePortfolioData = [
            { name: "Apple Inc. (AAPL)", value: 2500, gain: 450 },
            { name: "Microsoft Corp (MSFT)", value: 1800, gain: 320 },
            { name: "NVIDIA Corporation (NVDA)", value: 1500, gain: 800 },
            { name: "Amazon.com Inc (AMZN)", value: 1200, gain: 180 },
            { name: "Tesla Inc (TSLA)", value: 1000, gain: -150 },
            { name: "S&P 500 ETF (SPY)", value: 3000, gain: 400 },
            { name: "Vanguard Total Stock Market ETF", value: 2200, gain: 320 },
            { name: "Bitcoin ETF", value: 800, gain: 200 },
            { name: "Google (Alphabet) Class A", value: 1400, gain: 250 },
            { name: "Meta Platforms Inc", value: 900, gain: -80 }
        ];


        function loadSampleData()
        {
            clearAll();
            samplePortfolioData.forEach(item =>
            {
                addRow(item.name, item.value, item.gain);
            });
            // showNotification('Sample portfolio data loaded successfully! 📊', 'success', 3000);
        }

        function exportResults()
        {
            const rows = document.querySelectorAll('#inputRows .input-row');
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Asset Name,Current Value,Gain/Loss,Invested Capital\n";

            rows.forEach(row =>
            {
                const inputs = row.querySelectorAll('input');
                const name = inputs[ 0 ].value.trim();
                const currentValue = parseFloat(inputs[ 1 ].value) || 0;
                const gainAmount = parseFloat(inputs[ 2 ].value) || 0;
                const investedAmount = currentValue - gainAmount;

                if (name && currentValue)
                {
                    csvContent += `"${name}",${currentValue},${gainAmount},${investedAmount}\n`;
                }
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "portfolio_analysis.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification('Portfolio analysis exported successfully! 📄', 'success', 3000);
        }

        function shareWebsite()
        {
            const url = window.location.href;
            if (navigator.clipboard)
            {
                navigator.clipboard.writeText(url).then(() =>
                {
                    showNotification('Website link copied to clipboard!', 'success', 5000);
                }).catch(() =>
                {
                    // Fallback if clipboard API fails
                    showNotification('Please copy this link to share: ' + url, 'info', 0);
                });
            } else
            {
                // Fallback for older browsers
                showNotification('Please copy this link to share: ' + url, 'info', 0);
            }
        }

        function switchView(viewType)
        {
            const chartView = document.getElementById('chartView');
            const tableView = document.getElementById('tableView');
            const chartBtn = document.getElementById('chartViewBtn');
            const tableBtn = document.getElementById('tableViewBtn');

            if (viewType === 'chart')
            {
                chartView.style.display = 'block';
                tableView.style.display = 'none';
                chartBtn.classList.add('active');
                tableBtn.classList.remove('active');
            } else
            {
                chartView.style.display = 'none';
                tableView.style.display = 'block';
                chartBtn.classList.remove('active');
                tableBtn.classList.add('active');

                // Populate table when switching to table view
                populatePerformanceTable();
            }
        }

        function populatePerformanceTable()
        {
            const tableBody = document.getElementById('performanceTableBody');
            if (!window.currentResults) return;

            const results = window.currentResults;
            const totalValue = results.reduce((sum, r) => sum + r.currentValue, 0);

            // Sort by current value descending
            const sortedResults = results.sort((a, b) => b.currentValue - a.currentValue);

            let html = '';
            sortedResults.forEach((result, index) =>
            {
                const returnPercent = (result.gainAmount / result.investedAmount) * 100;
                const portfolioPercent = (result.currentValue / totalValue) * 100;
                const returnClass = returnPercent >= 0 ? 'positive-return' : 'negative-return';

                html += `
                    <tr>
                        <td class="rank-cell">${index + 1}</td>
                        <td class="asset-name">${result.name.length > 40 ? result.name.substring(0, 40) + '...' : result.name}</td>
                        <td>${formatCurrency(result.currentValue)}</td>
                        <td>${formatCurrency(result.investedAmount)}</td>
                        <td class="${returnClass}">${result.gainAmount >= 0 ? '+' : ''}${formatCurrency(result.gainAmount)}</td>
                        <td class="${returnClass}">${returnPercent >= 0 ? '+' : ''}${returnPercent.toFixed(2)}%</td>
                        <td>${portfolioPercent.toFixed(1)}%</td>
                    </tr>
                `;
            });

            tableBody.innerHTML = html;
        }

        function printResults()
        {
            window.print();
        }

        function addRow(name = "", value = "", gain = "")
        {
            rowCount++;
            const inputRows = document.getElementById('inputRows');
            const newRow = document.createElement('div');
            newRow.className = 'input-row';
            newRow.id = `row-${rowCount}`;

            const currencySymbol = currentCurrency === 'USD' ? '$' : 'KSh';

            newRow.innerHTML = `
                <input type="text" placeholder="Enter asset name" value="${name}" onchange="updateRow(${rowCount})">
                <input type="number" step="0.01" placeholder="Current Value (${currencySymbol})" value="${value}" onchange="updateRow(${rowCount})">
                <input type="number" step="0.01" placeholder="Gain/Loss (${currencySymbol})" value="${gain}" onchange="updateRow(${rowCount})">
                <button class="remove-btn" onclick="removeRow(${rowCount})" title="Remove asset">×</button>
            `;

            inputRows.appendChild(newRow);
        }

        function removeRow(rowId)
        {
            const row = document.getElementById(`row-${rowId}`);
            if (row)
            {
                row.remove();
            }
        }

        function updateRow(rowId)
        {
            // This function can be used for future enhancements
            // Currently just validates input
        }

        function clearAll()
        {
            document.getElementById('inputRows').innerHTML = '';
            document.getElementById('results').style.display = 'none';
            document.querySelector('.export-btn').style.display = 'none';
            rowCount = 0;
        }

        function calculate()
        {
            const rows = document.querySelectorAll('#inputRows .input-row');
            let totalCurrentValue = 0;
            let totalInvestedCapital = 0;
            let totalProfitLoss = 0;
            let results = [];

            rows.forEach(row =>
            {
                const inputs = row.querySelectorAll('input');
                const name = inputs[ 0 ].value.trim();
                const currentValue = parseFloat(inputs[ 1 ].value) || 0;
                const gainAmount = parseFloat(inputs[ 2 ].value) || 0;

                if (name && currentValue)
                {
                    const investedAmount = currentValue - gainAmount;

                    results.push({
                        name,
                        currentValue,
                        gainAmount,
                        investedAmount
                    });

                    totalCurrentValue += currentValue;
                    totalInvestedCapital += investedAmount;
                    totalProfitLoss += gainAmount;
                }
            });

            if (results.length === 0)
            {
                showNotification('Please add at least one asset to analyze your portfolio!', 'warning', 4000);
                return;
            }

            displayResults(results, totalCurrentValue, totalInvestedCapital, totalProfitLoss);
            showNotification(`Portfolio analysis complete! Analyzed ${results.length} assets successfully 🎉`, 'success', 4000);
        }

        function displayResults(results, totalCurrentValue, totalInvestedCapital, totalProfitLoss)
        {
            const resultsDiv = document.getElementById('results');
            const resultsList = document.getElementById('resultsList');

            // Store results globally for table view
            window.currentResults = results;

            let html = '';

            results.forEach(result =>
            {
                const profitLossClass = result.gainAmount > 0 ? 'profit' : result.gainAmount < 0 ? 'loss' : 'neutral';
                html += `
                    <div class="result-item">
                        <span>${result.name}</span>
                        <span>${formatCurrency(result.investedAmount)} → ${formatCurrency(result.currentValue)} (<span class="${profitLossClass}">${result.gainAmount >= 0 ? '+' : ''}${formatCurrency(result.gainAmount)}</span>)</span>
                    </div>
                `;
            });

            html += `
                <div class="result-item">
                    <span>💰 Total Invested Capital</span>
                    <span>${formatCurrency(totalInvestedCapital)}</span>
                </div>
            `;

            resultsList.innerHTML = html;

            // Create chart and analysis
            createPortfolioChart(results);
            populatePerformanceTable(); // Populate table by default since it's the default view
            generateAnalysis(results, totalCurrentValue, totalInvestedCapital, totalProfitLoss);
            fetchMarketData(); // Load market data

            resultsDiv.style.display = 'block';

            // Show export button after calculation
            document.querySelector('.export-btn').style.display = 'inline-block';

            // Smooth scroll to results
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function createPortfolioChart(results)
        {
            const ctx = document.getElementById('portfolioChart').getContext('2d');

            // Sort results by current value for better visualization
            const sortedResults = results.sort((a, b) => b.currentValue - a.currentValue);

            // Take top 15 holdings for cleaner chart
            const topHoldings = sortedResults.slice(0, 15);
            const otherHoldings = sortedResults.slice(15);

            const labels = topHoldings.map(r => r.name.length > 20 ? r.name.substring(0, 20) + '...' : r.name);
            const data = topHoldings.map(r => r.currentValue);
            const colors = generateColors(topHoldings.length);

            // Add "Others" category if there are more than 15 holdings
            if (otherHoldings.length > 0)
            {
                const otherTotal = otherHoldings.reduce((sum, r) => sum + r.currentValue, 0);
                labels.push(`Others (${otherHoldings.length})`);
                data.push(otherTotal);
                colors.push('#95a5a6');
            }

            // Destroy existing chart if it exists
            if (window.portfolioChart && typeof window.portfolioChart.destroy === 'function')
            {
                window.portfolioChart.destroy();
            }

            window.portfolioChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [ {
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    } ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: window.innerWidth < 768 ? 'bottom' : 'right',
                            labels: {
                                boxWidth: window.innerWidth < 768 ? 10 : 12,
                                font: {
                                    size: window.innerWidth < 768 ? 10 : 11
                                },
                                padding: window.innerWidth < 768 ? 8 : 12
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context)
                                {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function generateColors(count)
        {
            const colors = [
                '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe',
                '#43e97b', '#38f9d7', '#ffecd2', '#fcb69f', '#a8edea', '#fed6e3',
                '#fad0c4', '#ffd1ff', '#ff9a9e', '#fecfef', '#fecfef', '#ffecd2'
            ];

            if (count <= colors.length)
            {
                return colors.slice(0, count);
            }

            // Generate additional colors if needed
            const additionalColors = [];
            for (let i = colors.length; i < count; i++)
            {
                const hue = (i * 137.508) % 360; // Golden angle approximation
                additionalColors.push(`hsl(${hue}, 70%, 60%)`);
            }

            return [ ...colors, ...additionalColors ];
        }

        // Market Data Functions
        async function fetchMarketData()
        {
            const marketContainer = document.getElementById('marketPerformance');

            try
            {
                // Try to fetch real market data only
                const marketData = await getRealMarketData();
                displayMarketData(marketData);
            } catch (error)
            {
                console.error('Error fetching real market data:', error);
                displayMarketError();
            }
        }

        // Real market data using multiple free APIs
        // Real market data using multiple free APIs
        async function getRealMarketData()
        {
            let marketData = [];

            // Method 1: Try Financial Modeling Prep API (free, no key required for basic data)
            try
            {
                const symbols = [ 'SPY', 'QQQ', 'DIA', 'IWM', 'GLD', 'TLT' ];
                const symbolsStr = symbols.join(',');

                const response = await fetch(`https://financialmodelingprep.com/api/v3/quote/${symbolsStr}?apikey=demo`);
                const stockData = await response.json();

                if (Array.isArray(stockData) && stockData.length > 0)
                {
                    const nameMap = {
                        'SPY': 'S&P 500 ETF',
                        'QQQ': 'NASDAQ 100',
                        'DIA': 'Dow Jones',
                        'IWM': 'Russell 2000',
                        'GLD': 'Gold ETF',
                        'TLT': 'US 20Y Treasury'
                    };

                    stockData.forEach(stock =>
                    {
                        if (stock.price && stock.changesPercentage !== undefined)
                        {
                            marketData.push({
                                name: nameMap[ stock.symbol ] || stock.symbol,
                                symbol: stock.symbol,
                                price: stock.price,
                                change: stock.change || 0,
                                changePercent: stock.changesPercentage || 0,
                                ytdPercent: stock.yearToDatePriceChangePercentage || 0
                            });
                        }
                    });
                }
            } catch (error)
            {
                console.log('Financial Modeling Prep API failed, trying crypto only...');
            }

            // Method 2: Add crypto data using CoinGecko API (very reliable and free)
            try
            {
                const cryptoResponse = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum&vs_currencies=usd&include_24hr_change=true');
                const cryptoData = await cryptoResponse.json();

                if (cryptoData.bitcoin)
                {
                    // Get historical data for YTD calculation
                    try
                    {
                        const historyResponse = await fetch('https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=365');
                        const historyData = await historyResponse.json();

                        const currentPrice = cryptoData.bitcoin.usd;
                        const yearStartPrice = historyData.prices[ 0 ][ 1 ];
                        const ytdPercent = ((currentPrice - yearStartPrice) / yearStartPrice) * 100;

                        marketData.push({
                            name: 'Bitcoin',
                            symbol: 'BTC-USD',
                            price: currentPrice,
                            change: (cryptoData.bitcoin.usd_24h_change / 100) * currentPrice,
                            changePercent: cryptoData.bitcoin.usd_24h_change || 0,
                            ytdPercent: ytdPercent
                        });
                    } catch (historyError)
                    {
                        // Use current price without YTD calculation
                        marketData.push({
                            name: 'Bitcoin',
                            symbol: 'BTC-USD',
                            price: cryptoData.bitcoin.usd,
                            change: (cryptoData.bitcoin.usd_24h_change / 100) * cryptoData.bitcoin.usd,
                            changePercent: cryptoData.bitcoin.usd_24h_change || 0,
                            ytdPercent: 0 // No YTD data available
                        });
                    }
                }

                if (cryptoData.ethereum)
                {
                    marketData.push({
                        name: 'Ethereum',
                        symbol: 'ETH-USD',
                        price: cryptoData.ethereum.usd,
                        change: (cryptoData.ethereum.usd_24h_change / 100) * cryptoData.ethereum.usd,
                        changePercent: cryptoData.ethereum.usd_24h_change || 0,
                        ytdPercent: 0 // No YTD data calculated for simplicity
                    });
                }
            } catch (error)
            {
                console.error('Error fetching crypto data:', error);
            }

            if (marketData.length === 0)
            {
                throw new Error('No market data could be fetched from any API');
            }

            console.log(`Successfully loaded ${marketData.length} market assets`);
            return marketData;
        }

        function displayMarketData(marketData)
        {
            const container = document.getElementById('marketPerformance');

            const marketHTML = marketData.map(asset =>
            {
                const isPositive = asset.ytdPercent >= 0;
                const colorClass = isPositive ? '#28a745' : '#dc3545';
                const bgColor = isPositive ? 'rgba(40, 167, 69, 0.1)' : 'rgba(220, 53, 69, 0.1)';

                return `
                    <div style="background: ${bgColor}; padding: 15px; border-radius: 8px; border-left: 4px solid ${colorClass}; text-align: center;">
                        <div style="font-weight: bold; color: #2c3e50; margin-bottom: 8px; font-size: 14px;">
                            ${asset.name}
                        </div>
                        <div style="font-size: 18px; font-weight: bold; color: #2c3e50; margin-bottom: 5px;">
                            ${formatMarketPrice(asset.price, asset.symbol)}
                        </div>
                        <div style="font-size: 12px; color: ${colorClass}; font-weight: 600; margin-bottom: 8px;">
                            ${isPositive ? '+' : ''}${asset.ytdPercent.toFixed(2)}% YTD
                        </div>
                        <div style="font-size: 11px; color: #6c757d;">
                            ${asset.symbol}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    ${marketHTML}
                </div>
                <div style="text-align: center; margin-top: 15px; padding: 10px; background: rgba(102, 126, 234, 0.1); border-radius: 6px;">
                    <small style="color: #6c757d; font-size: 11px;">
                        📊 Live market data from Financial Modeling Prep, Yahoo Finance & CoinGecko APIs. Data may be delayed 15-20 minutes.
                    </small>
                </div>
            `;
        }

        function formatMarketPrice(price, symbol)
        {
            if (symbol.includes('BTC') || symbol.includes('ETH'))
            {
                return formatCurrency(price);
            } else if (symbol === '^TNX')
            {
                return price.toFixed(2) + '%';
            } else if (symbol === 'GC=F')
            {
                return '$' + price.toFixed(2);
            } else
            {
                return formatNumber(price);
            }
        }

        function displayMarketError()
        {
            const container = document.getElementById('marketPerformance');
            container.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #6c757d;">
                    <div style="font-size: 48px; margin-bottom: 10px;">📊</div>
                    <div style="font-size: 16px; margin-bottom: 5px;">Market Data Unavailable</div>
                    <div style="font-size: 12px;">Unable to fetch current market performance</div>
                </div>
            `;
        }

        // Risk Tolerance Calculation Functions
        function calculateRiskTolerance(results, totalValue)
        {
            const positions = results.map(r => ({
                ...r,
                portfolioPercent: (r.currentValue / totalValue) * 100,
                returnPercent: (r.gainAmount / r.investedAmount) * 100
            }));

            // Factors that determine risk tolerance
            let riskScore = 0;

            // 1. Individual stocks vs ETFs (higher individual stock percentage = higher risk)
            const individualStocks = positions.filter(p =>
                !p.name.toLowerCase().includes('etf') &&
                !p.name.toLowerCase().includes('trust') &&
                !p.name.toLowerCase().includes('index')
            ).length;
            const stockPercent = (individualStocks / results.length) * 100;
            if (stockPercent > 80) riskScore += 30;
            else if (stockPercent > 60) riskScore += 20;
            else if (stockPercent > 40) riskScore += 10;
            else riskScore += 0;

            // 2. Portfolio concentration (higher concentration = higher risk)
            const topPosition = Math.max(...positions.map(p => p.portfolioPercent));
            if (topPosition > 25) riskScore += 25;
            else if (topPosition > 20) riskScore += 20;
            else if (topPosition > 15) riskScore += 15;
            else if (topPosition > 10) riskScore += 10;
            else riskScore += 5;

            // 3. Tech sector exposure (higher tech = higher risk)
            const techExposure = positions.filter(p =>
                p.name.toLowerCase().includes('tech') ||
                p.name.toLowerCase().includes('nvidia') ||
                p.name.toLowerCase().includes('apple') ||
                p.name.toLowerCase().includes('amazon') ||
                p.name.toLowerCase().includes('tesla') ||
                p.name.toLowerCase().includes('alphabet') ||
                p.name.toLowerCase().includes('microsoft') ||
                p.name.toLowerCase().includes('semiconductor')
            ).reduce((sum, p) => sum + p.portfolioPercent, 0);
            if (techExposure > 50) riskScore += 20;
            else if (techExposure > 35) riskScore += 15;
            else if (techExposure > 25) riskScore += 10;
            else riskScore += 5;

            // 4. Crypto exposure (higher crypto = higher risk)
            const cryptoExposure = positions.filter(p =>
                p.name.toLowerCase().includes('bitcoin') ||
                p.name.toLowerCase().includes('ethereum') ||
                p.name.toLowerCase().includes('solana') ||
                p.name.toLowerCase().includes('ethereum') ||
                p.name.toLowerCase().includes('crypto')
            ).reduce((sum, p) => sum + p.portfolioPercent, 0);
            if (cryptoExposure > 15) riskScore += 15;
            else if (cryptoExposure > 10) riskScore += 10;
            else if (cryptoExposure > 5) riskScore += 5;

            // 5. Growth vs Value (growth stocks tend to be riskier)
            const growthStocks = positions.filter(p =>
                p.name.toLowerCase().includes('ark') ||
                p.name.toLowerCase().includes('growth') ||
                p.name.toLowerCase().includes('innovation') ||
                p.returnPercent > 50
            ).length;
            const growthPercent = (growthStocks / results.length) * 100;
            if (growthPercent > 40) riskScore += 15;
            else if (growthPercent > 25) riskScore += 10;
            else if (growthPercent > 15) riskScore += 5;

            // 6. Bond allocation (more bonds = lower risk)
            const bondExposure = positions.filter(p =>
                p.name.toLowerCase().includes('bond') ||
                p.name.toLowerCase().includes('treasury') ||
                p.name.toLowerCase().includes('fixed income')
            ).reduce((sum, p) => sum + p.portfolioPercent, 0);
            if (bondExposure < 5) riskScore += 10;
            else if (bondExposure < 15) riskScore += 5;
            else if (bondExposure > 30) riskScore -= 10;

            // 7. International diversification (more international = potentially lower risk)
            const internationalExposure = positions.filter(p =>
                p.name.toLowerCase().includes('international') ||
                p.name.toLowerCase().includes('global') ||
                p.name.toLowerCase().includes('world') ||
                p.name.toLowerCase().includes('developed') ||
                p.name.toLowerCase().includes('emerging')
            ).reduce((sum, p) => sum + p.portfolioPercent, 0);
            if (internationalExposure < 5) riskScore += 5;

            // Convert score to risk level
            if (riskScore >= 80) return "High";
            else if (riskScore >= 60) return "Mod-High";
            else if (riskScore >= 40) return "Moderate";
            else if (riskScore >= 25) return "Mod-Low";
            else return "Conservative";
        }

        function getRiskToleranceDescription(results, totalValue)
        {
            const riskLevel = calculateRiskTolerance(results, totalValue);

            switch (riskLevel)
            {
                case "High":
                    return "Aggressive investor";
                case "Mod-High":
                    return "Growth-focused";
                case "Moderate":
                    return "Balanced approach";
                case "Mod-Low":
                    return "Cautious growth";
                case "Conservative":
                    return "Risk-averse";
                default:
                    return "Balanced approach";
            }
        }

        function getRiskToleranceEmoji(results, totalValue)
        {
            const riskLevel = calculateRiskTolerance(results, totalValue);

            switch (riskLevel)
            {
                case "High":
                    return "🚀 High reward potential";
                case "Mod-High":
                    return "📈 Growth oriented";
                case "Moderate":
                    return "⚖️ Well balanced";
                case "Mod-Low":
                    return "🛡️ Steady growth";
                case "Conservative":
                    return "🏦 Capital preservation";
                default:
                    return "⚖️ Well balanced";
            }
        }

        function generateAnalysis(results, totalCurrentValue, totalInvestedCapital, totalProfitLoss)
        {
            const analysisDiv = document.getElementById('analysisSection');

            // Calculate metrics
            const totalReturn = ((totalProfitLoss / totalInvestedCapital) * 100);
            const winners = results.filter(r => r.gainAmount > 0);
            const losers = results.filter(r => r.gainAmount < 0);
            const breakeven = results.filter(r => r.gainAmount === 0);

            // Find best and worst performers
            const bestPerformer = results.reduce((best, current) =>
                (current.gainAmount / current.investedAmount) > (best.gainAmount / best.investedAmount) ? current : best
            );
            const worstPerformer = results.reduce((worst, current) =>
                (current.gainAmount / current.investedAmount) < (worst.gainAmount / worst.investedAmount) ? current : worst
            );

            // Calculate diversification metrics
            const topHolding = results.reduce((max, current) => current.currentValue > max.currentValue ? current : max);
            const topHoldingPercent = (topHolding.currentValue / totalCurrentValue) * 100;

            // Identify asset types
            const stocks = results.filter(r => !r.name.includes('ETF') && !r.name.includes('Trust')).length;
            const etfs = results.filter(r => r.name.includes('ETF') || r.name.includes('Trust')).length;

            let analysisHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, ${totalReturn >= 0 ? '#28a745, #20c997' : '#dc3545, #c82333'}); color: white; padding: 15px; border-radius: 10px; text-align: center; position: relative; overflow: hidden;">
                        <div style="position: absolute; top: -10px; right: -10px; font-size: 30px; opacity: 0.2;">
                            ${totalReturn >= 0 ? '📈' : '📉'}
                        </div>
                        <h4 style="margin: 0 0 8px 0; font-size: 14px;">Total Return</h4>
                        <div style="font-size: 22px; font-weight: bold;">${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(2)}%</div>
                        <div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">${formatCurrency(totalProfitLoss)} ${totalReturn >= 0 ? 'profit' : 'loss'}</div>
                        <div style="font-size: 10px; opacity: 0.8; margin-top: 4px;">
                            ${totalReturn >= 0 ? '🎉 Great job!' : '💪 Stay strong!'}
                        </div>
                    </div>

                    <div style="background: linear-gradient(135deg, #17a2b8, #138496); color: white; padding: 15px; border-radius: 10px; text-align: center; position: relative; overflow: hidden;">
                        <div style="position: absolute; top: -10px; right: -10px; font-size: 30px; opacity: 0.2;">💰</div>
                        <h4 style="margin: 0 0 8px 0; font-size: 14px;">Portfolio Size</h4>
                        <div style="font-size: 22px; font-weight: bold;">${formatCurrency(totalCurrentValue)}</div>
                        <div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">${results.length} holdings</div>
                        <div style="font-size: 10px; opacity: 0.8; margin-top: 4px;">
                            Avg: ${formatCurrency(totalCurrentValue / results.length)}
                        </div>
                    </div>

                    <div style="background: linear-gradient(135deg, #6f42c1, #563d7c); color: white; padding: 15px; border-radius: 10px; text-align: center; position: relative; overflow: hidden;">
                        <div style="position: absolute; top: -10px; right: -10px; font-size: 30px; opacity: 0.2;">🎯</div>
                        <h4 style="margin: 0 0 8px 0; font-size: 14px;">Win Rate</h4>
                        <div style="font-size: 22px; font-weight: bold;">${((winners.length / results.length) * 100).toFixed(1)}%</div>
                        <div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">${winners.length}W • ${losers.length}L</div>
                        <div style="font-size: 10px; opacity: 0.8; margin-top: 4px;">
                            ${((winners.length / results.length) * 100) > 70 ? '🏆 Excellent!' : ((winners.length / results.length) * 100) > 50 ? '👍 Good!' : '📚 Keep learning!'}
                        </div>
                    </div>

                    <div style="background: linear-gradient(135deg, #6f42c1, #563d7c); color: white; padding: 15px; border-radius: 10px; text-align: center; position: relative; overflow: hidden;">
                        <div style="position: absolute; top: -10px; right: -10px; font-size: 30px; opacity: 0.2;">⚖️</div>
                        <h4 style="margin: 0 0 8px 0; font-size: 14px;">Risk Tolerance</h4>
                        <div style="font-size: 20px; font-weight: bold;">${calculateRiskTolerance(results, totalCurrentValue)}</div>
                        <div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">${getRiskToleranceDescription(results, totalCurrentValue)}</div>
                        <div style="font-size: 10px; opacity: 0.8; margin-top: 4px;">
                            ${getRiskToleranceEmoji(results, totalCurrentValue)}
                        </div>
                    </div>

                    <div style="background: linear-gradient(135deg, #fd7e14, #e55a4e); color: white; padding: 15px; border-radius: 10px; text-align: center; position: relative; overflow: hidden;">
                        <div style="position: absolute; top: -10px; right: -10px; font-size: 30px; opacity: 0.2;">⚡</div>
                        <h4 style="margin: 0 0 8px 0; font-size: 14px;">Best Performer</h4>
                        <div style="font-size: 20px; font-weight: bold;">+${((bestPerformer.gainAmount / bestPerformer.investedAmount) * 100).toFixed(1)}%</div>
                        <div style="font-size: 10px; opacity: 0.9; margin-top: 4px;">${bestPerformer.name.length > 20 ? bestPerformer.name.substring(0, 20) + '...' : bestPerformer.name}</div>
                        <div style="font-size: 10px; opacity: 0.8; margin-top: 2px;">
                            ${formatCurrency(bestPerformer.gainAmount)} gain
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 25px;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">🏆 Performance Highlights</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                        <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 15px; border-radius: 8px; position: relative;">
                            <div style="position: absolute; top: 10px; right: 15px; font-size: 20px; opacity: 0.7;">🏆</div>
                            <strong style="font-size: 14px;">Best Performer</strong><br>
                            <div style="font-size: 14px; margin-top: 5px;">${bestPerformer.name.length > 30 ? bestPerformer.name.substring(0, 30) + '...' : bestPerformer.name}</div>
                            <div style="font-size: 18px; font-weight: bold; margin-top: 8px;">
                                +${((bestPerformer.gainAmount / bestPerformer.investedAmount) * 100).toFixed(2)}%
                            </div>
                            <div style="font-size: 12px; opacity: 0.9; margin-top: 5px;">
                                ${formatCurrency(bestPerformer.gainAmount)} profit
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 15px; border-radius: 8px; position: relative;">
                            <div style="position: absolute; top: 10px; right: 15px; font-size: 20px; opacity: 0.7;">📉</div>
                            <strong style="font-size: 14px;">Worst Performer</strong><br>
                            <div style="font-size: 14px; margin-top: 5px;">${worstPerformer.name.length > 30 ? worstPerformer.name.substring(0, 30) + '...' : worstPerformer.name}</div>
                            <div style="font-size: 18px; font-weight: bold; margin-top: 8px;">
                                ${((worstPerformer.gainAmount / worstPerformer.investedAmount) * 100).toFixed(2)}%
                            </div>
                            <div style="font-size: 12px; opacity: 0.9; margin-top: 5px;">
                                ${formatCurrency(worstPerformer.gainAmount)} ${worstPerformer.gainAmount >= 0 ? 'gain' : 'loss'}
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 25px;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">📊 Portfolio Composition & Asset Allocation</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; text-align: center; border-left: 4px solid #17a2b8;">
                            <div style="font-size: 20px; font-weight: bold; color: #17a2b8; margin-bottom: 4px;">${stocks}</div>
                            <div style="font-size: 12px; color: #6c757d;">Individual Stocks</div>
                            <div style="font-size: 10px; color: #6c757d; margin-top: 2px;">${((stocks / results.length) * 100).toFixed(1)}% of holdings</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; text-align: center; border-left: 4px solid #28a745;">
                            <div style="font-size: 20px; font-weight: bold; color: #28a745; margin-bottom: 4px;">${etfs}</div>
                            <div style="font-size: 12px; color: #6c757d;">ETFs/Funds</div>
                            <div style="font-size: 10px; color: #6c757d; margin-top: 2px;">${((etfs / results.length) * 100).toFixed(1)}% of holdings</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; text-align: center; border-left: 4px solid #fd7e14;">
                            <div style="font-size: 18px; font-weight: bold; color: #fd7e14; margin-bottom: 4px;">${topHoldingPercent.toFixed(1)}%</div>
                            <div style="font-size: 12px; color: #6c757d;">Largest Position</div>
                            <div style="font-size: 10px; color: #6c757d; margin-top: 2px;">${topHolding.name.length > 12 ? topHolding.name.substring(0, 12) + '...' : topHolding.name}</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; text-align: center; border-left: 4px solid #6f42c1;">
                            <div style="font-size: 16px; font-weight: bold; color: #6f42c1; margin-bottom: 4px;">${formatCurrency(totalCurrentValue / results.length)}</div>
                            <div style="font-size: 12px; color: #6c757d;">Avg. Position Size</div>
                            <div style="font-size: 10px; color: #6c757d; margin-top: 2px;">Per holding value</div>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 25px;">
                    <div>
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">🏆 Top 5 Performers</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                            ${generateTopPerformers(results, 5)}
                        </div>
                    </div>
                    <div>
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">📉 Bottom 5 Performers</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #dc3545;">
                            ${generateBottomPerformers(results, 5)}
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 25px;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">📊 Performance Distribution</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        ${generatePerformanceDistribution(results)}
                    </div>
                </div>

                <div style="margin-bottom: 25px;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">🎯 Risk Analysis</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        ${generateRiskAnalysis(results, totalCurrentValue)}
                    </div>
                </div>

                <div>
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">💡 Personalized Insights & Recommendations</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        ${generateRecommendations(results, totalCurrentValue, topHoldingPercent, winners.length, results.length)}
                    </div>
                </div>
            `;

            analysisDiv.innerHTML = analysisHTML;
        }

        function generateTopPerformers(results, count)
        {
            const sortedByPerformance = results
                .map(r => ({
                    ...r,
                    returnPercent: (r.gainAmount / r.investedAmount) * 100
                }))
                .sort((a, b) => b.returnPercent - a.returnPercent)
                .slice(0, count);

            if (sortedByPerformance.length === 0)
            {
                return '<div style="text-align: center; color: #6c757d; padding: 20px;">No data available</div>';
            }

            return sortedByPerformance
                .map((r, index) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: ${index === sortedByPerformance.length - 1 ? 'none' : '1px solid #dee2e6'}; flex-wrap: wrap; gap: 8px;">
                        <div style="flex: 1; min-width: 200px;">
                            <div style="font-weight: 600; color: #2c3e50; margin-bottom: 2px; font-size: 14px;">
                                ${index + 1}. ${r.name.length > 25 ? r.name.substring(0, 25) + '...' : r.name}
                            </div>
                            <div style="font-size: 11px; color: #6c757d;">
                                ${formatCurrency(r.investedAmount)} → ${formatCurrency(r.currentValue)}
                            </div>
                        </div>
                        <div style="text-align: right; min-width: 80px;">
                            <div style="color: #28a745; font-weight: bold; font-size: 15px;">
                                +${r.returnPercent.toFixed(2)}%
                            </div>
                            <div style="font-size: 11px; color: #28a745; font-weight: 600;">
                                ${formatCurrency(r.gainAmount)}
                            </div>
                        </div>
                    </div>
                `).join('');
        }

        function generateBottomPerformers(results, count)
        {
            const sortedByPerformance = results
                .map(r => ({
                    ...r,
                    returnPercent: (r.gainAmount / r.investedAmount) * 100
                }))
                .sort((a, b) => a.returnPercent - b.returnPercent)
                .slice(0, count);

            if (sortedByPerformance.length === 0)
            {
                return '<div style="text-align: center; color: #6c757d; padding: 20px;">No data available</div>';
            }

            return sortedByPerformance
                .map((r, index) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: ${index === sortedByPerformance.length - 1 ? 'none' : '1px solid #dee2e6'}; flex-wrap: wrap; gap: 8px;">
                        <div style="flex: 1; min-width: 200px;">
                            <div style="font-weight: 600; color: #2c3e50; margin-bottom: 2px; font-size: 14px;">
                                ${index + 1}. ${r.name.length > 25 ? r.name.substring(0, 25) + '...' : r.name}
                            </div>
                            <div style="font-size: 11px; color: #6c757d;">
                                ${formatCurrency(r.investedAmount)} → ${formatCurrency(r.currentValue)}
                            </div>
                        </div>
                        <div style="text-align: right; min-width: 80px;">
                            <div style="color: ${r.returnPercent >= 0 ? '#28a745' : '#dc3545'}; font-weight: bold; font-size: 15px;">
                                ${r.returnPercent >= 0 ? '+' : ''}${r.returnPercent.toFixed(2)}%
                            </div>
                            <div style="font-size: 11px; color: ${r.returnPercent >= 0 ? '#28a745' : '#dc3545'}; font-weight: 600;">
                                ${formatCurrency(r.gainAmount)}
                            </div>
                        </div>
                    </div>
                `).join('');
        }

        function generatePerformanceDistribution(results)
        {
            const ranges = [
                { label: 'Massive Gains (50%+)', min: 50, max: Infinity, color: '#28a745', icon: '🚀' },
                { label: 'Strong Gains (20-50%)', min: 20, max: 50, color: '#20c997', icon: '📈' },
                { label: 'Moderate Gains (5-20%)', min: 5, max: 20, color: '#17a2b8', icon: '📊' },
                { label: 'Small Gains (0-5%)', min: 0, max: 5, color: '#6f42c1', icon: '📉' },
                { label: 'Losses (Below 0%)', min: -Infinity, max: 0, color: '#dc3545', icon: '⚠️' }
            ];

            const distribution = ranges.map(range =>
            {
                const holdings = results.filter(r =>
                {
                    const returnPercent = (r.gainAmount / r.investedAmount) * 100;
                    return returnPercent >= range.min && returnPercent < range.max;
                });

                const totalValue = holdings.reduce((sum, h) => sum + h.currentValue, 0);
                const portfolioTotal = results.reduce((sum, r) => sum + r.currentValue, 0);
                const percentage = portfolioTotal > 0 ? (totalValue / portfolioTotal) * 100 : 0;

                return {
                    ...range,
                    count: holdings.length,
                    value: totalValue,
                    percentage: percentage
                };
            });

            return distribution.map(range => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #dee2e6;">
                    <div style="display: flex; align-items: center;">
                        <span style="margin-right: 10px; font-size: 18px;">${range.icon}</span>
                        <div>
                            <div style="font-weight: 600; color: ${range.color};">${range.label}</div>
                            <div style="font-size: 12px; color: #6c757d;">${range.count} holdings</div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: bold; color: ${range.color};">
                            ${range.percentage.toFixed(1)}%
                        </div>
                        <div style="font-size: 12px; color: #6c757d;">
                            ${formatCurrency(range.value)}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function generateRiskAnalysis(results, totalValue)
        {
            // Calculate position sizes
            const positions = results.map(r => ({
                ...r,
                portfolioPercent: (r.currentValue / totalValue) * 100,
                returnPercent: (r.gainAmount / r.investedAmount) * 100
            }));

            // Risk metrics
            const largePositions = positions.filter(p => p.portfolioPercent > 10);
            const volatilePositions = positions.filter(p => Math.abs(p.returnPercent) > 30);
            const concentrationRisk = positions.reduce((max, p) => Math.max(max, p.portfolioPercent), 0);

            // Sector analysis (simplified)
            const techExposure = positions.filter(p =>
                p.name.toLowerCase().includes('tech') ||
                p.name.includes('NVIDIA') ||
                p.name.includes('Apple') ||
                p.name.includes('Amazon') ||
                p.name.includes('Tesla') ||
                p.name.includes('Alphabet') ||
                p.name.includes('Microsoft')
            ).reduce((sum, p) => sum + p.portfolioPercent, 0);

            const etfExposure = positions.filter(p =>
                p.name.includes('ETF') ||
                p.name.includes('Trust') ||
                p.name.includes('Index')
            ).reduce((sum, p) => sum + p.portfolioPercent, 0);

            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: bold; color: ${concentrationRisk > 20 ? '#dc3545' : concentrationRisk > 15 ? '#fd7e14' : '#28a745'};">
                            ${concentrationRisk.toFixed(1)}%
                        </div>
                        <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">Largest Position</div>
                        <div style="font-size: 10px; color: #6c757d;">
                            ${concentrationRisk > 20 ? 'High Risk' : concentrationRisk > 15 ? 'Moderate Risk' : 'Low Risk'}
                        </div>
                    </div>

                    <div style="text-align: center; padding: 15px; background: rgba(40, 167, 69, 0.1); border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: bold; color: #28a745;">
                            ${largePositions.length}
                        </div>
                        <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">Large Positions (&gt;10%)</div>
                        <div style="font-size: 10px; color: #6c757d;">
                            ${largePositions.length > 3 ? 'Monitor closely' : 'Well managed'}
                        </div>
                    </div>

                    <div style="text-align: center; padding: 15px; background: rgba(23, 162, 184, 0.1); border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: bold; color: #17a2b8;">
                            ${techExposure.toFixed(0)}%
                        </div>
                        <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">Tech Sector</div>
                        <div style="font-size: 10px; color: #6c757d;">
                            ${techExposure > 40 ? 'High exposure' : techExposure > 25 ? 'Moderate' : 'Balanced'}
                        </div>
                    </div>

                    <div style="text-align: center; padding: 15px; background: rgba(111, 66, 193, 0.1); border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: bold; color: #6f42c1;">
                            ${etfExposure.toFixed(0)}%
                        </div>
                        <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">ETF Allocation</div>
                        <div style="font-size: 10px; color: #6c757d;">
                            ${etfExposure > 50 ? 'Conservative' : etfExposure > 30 ? 'Balanced' : 'Aggressive'}
                        </div>
                    </div>
                </div>

                ${volatilePositions.length > 0 ? `
                <div style="margin-top: 15px; padding: 12px; background: rgba(255, 193, 7, 0.1); border-left: 4px solid #ffc107; border-radius: 4px;">
                    <strong>⚡ High Volatility Alert:</strong> ${volatilePositions.length} position(s) with extreme moves (&gt;30%).
                    Consider reviewing: ${volatilePositions.slice(0, 100).map(p => p.name.split(' ')[ 0 ]).join(', ')}${volatilePositions.length > 100 ? '...' : ''}
                </div>
                ` : ''}
            `;
        }

        function generateRecommendations(results, totalValue, topHoldingPercent, winnerCount, totalCount)
        {
            let recommendations = [];

            // Advanced performance analysis
            const positions = results.map(r => ({
                ...r,
                returnPercent: (r.gainAmount / r.investedAmount) * 100,
                portfolioPercent: (r.currentValue / totalValue) * 100
            }));

            const winRate = (winnerCount / totalCount) * 100;
            const avgReturn = positions.reduce((sum, p) => sum + p.returnPercent, 0) / positions.length;
            const bigWinners = positions.filter(p => p.returnPercent > 50);
            const bigLosers = positions.filter(p => p.returnPercent < -20);

            // Performance-based recommendations
            if (bigWinners.length > 0)
            {
                recommendations.push(`🎯 <strong>Profit-Taking Strategy:</strong> You have ${bigWinners.length} position(s) with 50%+ gains (${bigWinners.map(p => p.name.split(' ')[ 0 ]).slice(0, 2).join(', ')}${bigWinners.length > 2 ? '...' : ''}). Consider taking partial profits to lock in gains and reduce risk concentration.`);
            }

            if (bigLosers.length > 0)
            {
                recommendations.push(`📉 <strong>Loss Review Needed:</strong> ${bigLosers.length} position(s) are down 20%+ (${bigLosers.map(p => p.name.split(' ')[ 0 ]).slice(0, 2).join(', ')}${bigLosers.length > 2 ? '...' : ''}). Consider tax-loss harvesting opportunities or reassess investment thesis.`);
            }

            // Concentration risk analysis
            if (topHoldingPercent > 25)
            {
                recommendations.push(`⚠️ <strong>Critical Concentration Risk:</strong> Your largest holding represents ${topHoldingPercent.toFixed(1)}% of your portfolio. This creates significant single-stock risk. Consider reducing to under 20% to protect your wealth.`);
            } else if (topHoldingPercent > 20)
            {
                recommendations.push(`📊 <strong>High Concentration Alert:</strong> Your largest holding is ${topHoldingPercent.toFixed(1)}% of your portfolio. While not dangerous, consider gradual reduction to under 15% for better risk management.`);
            } else if (topHoldingPercent > 15)
            {
                recommendations.push(`📈 <strong>Moderate Concentration:</strong> Your largest holding at ${topHoldingPercent.toFixed(1)}% is manageable but worth monitoring. Consider setting a 20% maximum for any single position.`);
            }

            // Win rate analysis with actionable advice
            if (winRate > 80)
            {
                recommendations.push(`🏆 <strong>Exceptional Stock Picker:</strong> ${winRate.toFixed(1)}% win rate is outstanding! Consider sharing your research process or methodology. You might benefit from position sizing optimization to maximize these skills.`);
            } else if (winRate > 70)
            {
                recommendations.push(`⭐ <strong>Strong Performance:</strong> ${winRate.toFixed(1)}% win rate shows excellent stock selection. Consider increasing position sizes in your highest-conviction picks while maintaining diversification.`);
            } else if (winRate > 60)
            {
                recommendations.push(`✅ <strong>Above-Average Results:</strong> ${winRate.toFixed(1)}% win rate is solid. Focus on letting winners run longer and cutting losers faster to improve returns.`);
            } else if (winRate < 40)
            {
                recommendations.push(`� <strong>Strategy Review Needed:</strong> ${winRate.toFixed(1)}% win rate suggests room for improvement. Consider focusing on higher-quality companies, improving entry timing, or adding more ETF diversification.`);
            }

            // Portfolio size recommendations
            if (totalCount > 40)
            {
                recommendations.push(`🎯 <strong>Over-Diversification Alert:</strong> With ${totalCount} holdings, you have "diworsification." Research shows optimal portfolios have 15-25 holdings. Consider consolidating into your highest-conviction positions.`);
            } else if (totalCount > 30)
            {
                recommendations.push(`📊 <strong>Portfolio Simplification:</strong> ${totalCount} holdings may be too many to monitor effectively. Consider focusing on your top 20-25 performers and selling underperformers.`);
            } else if (totalCount < 8)
            {
                recommendations.push(`📈 <strong>Add Diversification:</strong> With only ${totalCount} holdings, consider adding 3-5 more quality positions across different sectors to reduce single-stock risk.`);
            }

            // Sector analysis
            const techStocks = positions.filter(p =>
                p.name.toLowerCase().includes('nvidia') || p.name.toLowerCase().includes('apple') ||
                p.name.toLowerCase().includes('amazon') || p.name.toLowerCase().includes('tesla') ||
                p.name.toLowerCase().includes('alphabet') || p.name.toLowerCase().includes('microsoft') ||
                p.name.toLowerCase().includes('uber') || p.name.toLowerCase().includes('palantir') ||
                p.name.toLowerCase().includes('semiconductor') || p.name.toLowerCase().includes('tech')
            );

            const techExposure = techStocks.reduce((sum, p) => sum + p.portfolioPercent, 0);

            if (techExposure > 50)
            {
                recommendations.push(`⚡ <strong>High Tech Concentration:</strong> Tech represents ${techExposure.toFixed(1)}% of your portfolio (${techStocks.length} positions). Consider adding defensive sectors like utilities, healthcare, or consumer staples for balance.`);
            } else if (techExposure > 35)
            {
                recommendations.push(`💻 <strong>Tech-Heavy Portfolio:</strong> ${techExposure.toFixed(1)}% tech exposure is significant. Consider adding some non-tech positions for diversification during tech downturns.`);
            }

            // ETF vs individual stock balance
            const etfCount = positions.filter(p => p.name.includes('ETF') || p.name.includes('Trust') || p.name.includes('Index')).length;
            const stockCount = totalCount - etfCount;
            const etfValue = positions.filter(p => p.name.includes('ETF') || p.name.includes('Trust')).reduce((sum, p) => sum + p.currentValue, 0);
            const etfPercent = (etfValue / totalValue) * 100;

            if (stockCount > etfCount * 4)
            {
                recommendations.push(`🛡️ <strong>Add ETF Foundation:</strong> You have ${stockCount} individual stocks vs ${etfCount} ETFs. Consider broad market ETFs (VTI, VOO) for 30-40% of your portfolio as a stable foundation.`);
            } else if (etfPercent > 70)
            {
                recommendations.push(`🚀 <strong>Stock Picking Opportunity:</strong> ${etfPercent.toFixed(1)}% in ETFs is conservative. If you enjoy research, consider adding some individual stock picks for potential outperformance.`);
            }

            // International diversification
            const internationalHoldings = positions.filter(p =>
                p.name.toLowerCase().includes('international') || p.name.toLowerCase().includes('global') ||
                p.name.toLowerCase().includes('world') || p.name.toLowerCase().includes('developed') ||
                p.name.toLowerCase().includes('emerging') || p.name.toLowerCase().includes('asml')
            );

            if (internationalHoldings.length === 0 && totalCount > 8)
            {
                recommendations.push(`🌍 <strong>Add International Exposure:</strong> Consider international diversification with ETFs like VTIAX (International) or VEA (Developed Markets) to reduce US market dependence.`);
            }

            // Crypto analysis
            const cryptoHoldings = positions.filter(p =>
                p.name.toLowerCase().includes('bitcoin') || p.name.toLowerCase().includes('ethereum') ||
                p.name.toLowerCase().includes('crypto')
            );

            if (cryptoHoldings.length > 0)
            {
                const cryptoValue = cryptoHoldings.reduce((sum, p) => sum + p.currentValue, 0);
                const cryptoPercent = (cryptoValue / totalValue) * 100;

                if (cryptoPercent > 15)
                {
                    recommendations.push(`₿ <strong>High Crypto Risk:</strong> Crypto represents ${cryptoPercent.toFixed(1)}% of your portfolio. Consider reducing to 5-10% maximum for risk management.`);
                } else if (cryptoPercent > 5)
                {
                    recommendations.push(`₿ <strong>Balanced Crypto Allocation:</strong> Your ${cryptoPercent.toFixed(1)}% crypto allocation provides good alternative asset exposure without excessive risk.`);
                }
            } else if (totalValue > 50000)
            {
                recommendations.push(`₿ <strong>Consider Crypto Allocation:</strong> A small 2-5% allocation to Bitcoin or Ethereum ETFs could provide portfolio diversification benefits.`);
            }

            // Value-based recommendations
            if (totalValue > 100000)
            {
                recommendations.push(`🏦 <strong>High-Value Portfolio Strategy:</strong> With ${formatCurrency(totalValue)}, consider tax-loss harvesting, estate planning, and potentially working with a fee-only financial advisor for optimization.`);
            } else if (totalValue > 50000)
            {
                recommendations.push(`💎 <strong>Tax Optimization Time:</strong> Your ${formatCurrency(totalValue)} portfolio warrants attention to tax efficiency. Maximize 401(k)/IRA contributions and consider tax-loss harvesting.`);
            } else if (totalValue > 25000)
            {
                recommendations.push(`📈 <strong>Building Wealth Stage:</strong> Great progress with ${formatCurrency(totalValue)}! Focus on consistent investing, low fees, and letting compound growth work its magic.`);
            }

            // Advanced strategy recommendations
            if (avgReturn > 15)
            {
                recommendations.push(`🎯 <strong>Consider Position Sizing:</strong> With ${avgReturn.toFixed(1)}% average returns, you might benefit from larger positions in your highest-conviction picks (up to 10-15% each).`);
            }

            const volatilePositions = positions.filter(p => Math.abs(p.returnPercent) > 40);
            if (volatilePositions.length > 3)
            {
                recommendations.push(`⚡ <strong>Volatility Management:</strong> ${volatilePositions.length} positions with extreme moves (>40%). Consider adding some stable dividend stocks or bonds for balance.`);
            }

            // Bond allocation recommendations
            const bondHoldings = positions.filter(p =>
                p.name.toLowerCase().includes('bond') || p.name.toLowerCase().includes('treasury') ||
                p.name.toLowerCase().includes('fixed income')
            );

            if (bondHoldings.length === 0 && totalValue > 50000)
            {
                recommendations.push(`🛡️ <strong>Consider Bond Allocation:</strong> A 10-30% bond allocation (TLT, BND, or SCHZ) can provide stability and reduce portfolio volatility during market downturns.`);
            }

            // Dividend strategy
            const dividendStocks = positions.filter(p =>
                p.name.toLowerCase().includes('dividend') || p.name.toLowerCase().includes('utilities') ||
                p.name.toLowerCase().includes('consumer staples') || p.name.toLowerCase().includes('reit')
            );

            if (dividendStocks.length === 0 && totalValue > 30000)
            {
                recommendations.push(`💰 <strong>Dividend Income Opportunity:</strong> Consider adding dividend-focused ETFs (VYM, SCHD, or VIG) for income generation and downside protection.`);
            }

            // Age-based recommendations (if portfolio size suggests certain age)
            if (totalValue > 200000)
            {
                recommendations.push(`🎓 <strong>Advanced Strategies:</strong> Consider dollar-cost averaging into new positions, rebalancing quarterly, and exploring sector rotation strategies for this sized portfolio.`);
            }

            // Emergency fund reminder
            if (totalValue > 1)
            {
                recommendations.push(`� <strong>Emergency Fund Check:</strong> Ensure you have 3-6 months of expenses in a high-yield savings account or MMF (separate from investments) before adding more to your portfolio.`);
            }

            // // Educational resources
            // recommendations.push(`📚 <strong>Continuous Learning:</strong> Keep researching! Consider following: SEC investor.gov, Morningstar research, company 10-K filings, and books like "The Intelligent Investor" or "One Up On Wall Street" for deeper knowledge.`);

            // Final motivational recommendation
            if (winRate > 60 && avgReturn > 10)
            {
                recommendations.push(`🚀 <strong>You're Doing Great!</strong> ${winRate.toFixed(1)}% win rate and ${avgReturn.toFixed(1)}% average returns show strong investing skills. Stay disciplined, keep learning, and let compound growth build your wealth!`);
            } else if (totalValue > 10000)
            {
                recommendations.push(`� <strong>Keep Building!</strong> Every great investor started somewhere. Focus on quality companies, diversification, and time in the market. Your ${formatCurrency(totalValue)} portfolio is a great foundation!`);
            }

            return recommendations.map(rec => `<div style="margin-bottom: 15px; padding: 12px; background: rgba(102, 126, 234, 0.05); border-left: 4px solid #667eea; border-radius: 4px; line-height: 1.5;">${rec}</div>`).join('');
        }

        // Load sample data by default for demo purposes
        window.onload = function ()
        {
            // Load sample data to show functionality
            loadSampleData();

            // Fetch real-time exchange rates
            fetchExchangeRates();

            // Initialize input labels with default currency
            updateInputLabels();
        };
    </script>
</body>

</html>